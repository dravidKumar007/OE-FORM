<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Page</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins&display=swap">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <form id="subjectForm">
        <h1>Select Subjects</h1><br>
        <center>
            <h3 id="userEmailDisplay"></h3>
            <h5 id="register"></h5>
        </center>
        <label for="subjectSelect">Select Subject:</label>
        <select id="subjectSelect" name="subjectSelect">
            <!-- Dropdown options will be dynamically populated here -->
        </select>
        <br>
        <button type="submit" id="submitButton">Submit</button>
    </form>

    <script>
        $(document).ready(function() {
            // Retrieve user email from local storage
            var userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                $("#userEmailDisplay").text("Logged in as: " + userEmail);
   getreg(userEmail);
            } else {
                $("#userEmailDisplay").text("Login again: the email is not stored properly");
            }

            // Retrieve registration number
            var registrationNumber;
            var years;
            var dept;
function getreg(userEmail){
            $.ajax({
                type: "GET",
                url: "get_register_number.php",
                data: { email: userEmail },
                success: function(response) {
                    alert(response);
                    var data = JSON.parse(response);
                    if (data.registrationNumber) {
                        registrationNumber = data.registrationNumber;
                            years = data.years;
                            dept = data.dept;
                            console.log(registrationNumber)
                        $('#register').text("Registration Number: " + registrationNumber);
                        getSubjects(dept,years );
                    } else {
                        alert("No registration number found for the given email.");
                    }
                },
                error: function(xhr, status, error) {
                    alert("An error occurred while retrieving the registration number: " + xhr.responseText);
                }
            });
        }

            // Disable submit button based on timestamp
            $.ajax({
                type: 'GET',
                url: 'get_timestamps.php',
                dataType: 'json',
                success: function(timestamps) {
                    var currentTimestamp = Date.now();
                    var disableTimestamp = timestamps.disable_timestamp * 1000 - 12600000;
                    var arrivalTimestamp = timestamps.arrival_timestamp * 1000 - 12600000;
                    if (!(currentTimestamp < disableTimestamp && currentTimestamp > arrivalTimestamp)) {
                        $('#submitButton').prop('disabled', true);
                        $('#submitButton').css('background-color', 'red');
                        $('#submitButton').text('Disabled');
                        $('#submitButton').css('cursor', 'not-allowed');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching timestamps:', error);
                }
            });

            // Retrieve subjects based on department and years


            function getSubjects(dept, years) {
                $.ajax({
                    type: "GET",
                    url: "get_subjects.php",
                    data: { dept: dept, years: years },
                    success: function(response) {
                        var subjects = JSON.parse(response);
                        subjects.forEach(function(subject) {
                            $('#subjectSelect').append($('<option>', {
                                value: subject.subject,
                                text: subject.subject + " (Available Seats: " + subject.available_seats + ")"
                            }));
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("An error occurred while retrieving subjects:", error);
                    }
                });
            }

            // Call function to retrieve subjects
            getSubjects();

            // Handle form submission
            $('#subjectForm').submit(function(event) {
                event.preventDefault();
                var selectedSubject = $('#subjectSelect').val();
                $.ajax({
                    type: "POST",
                    url: "save_subject.php",
                    data: { register_no: registrationNumber, subject: selectedSubject },
                    success: function(response) {
                        alert(response);
                        window.location.href = "done.html";
                    },
                    error: function(xhr, status, error) {
                        if ((xhr.responseText).includes('Duplicate entry')) {
                            alert("Already booked the subject");
                        } else {
                            alert(xhr.responseText);
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
